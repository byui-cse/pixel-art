<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Art Coordinate Challenge</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --grid-size: min(90vw, 400px);
      --cell-size: calc(var(--grid-size) / 12);
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --accent: #e94560;
      --accent-hover: #ff6b6b;
      --text: #eee;
      --text-muted: #aaa;
      --success: #4ecca3;
      --grid-line: #2a2a4a;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
      line-height: 1.5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 1.5rem;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .share-btn {
      margin-top: 1rem;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 0.4rem 1.25rem;
      font-size: 0.875rem;
    }

    .share-btn:hover {
      background: var(--accent);
      color: white;
    }

    .share-toast {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--success);
      color: #111;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      z-index: 1000;
    }

    .share-toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      padding: 1rem;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      text-align: center;
      position: relative;
    }

    .modal-content h2 {
      color: var(--accent);
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .modal-close {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.75rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text);
      background: none;
    }

    .qr-container {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      display: inline-block;
      margin-bottom: 1rem;
    }

    .qr-container img {
      display: block;
      width: 180px;
      height: 180px;
    }

    .modal-instruction {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .share-url-container {
      display: flex;
      gap: 0.5rem;
    }

    .share-url-container input {
      flex: 1;
      background: #0d1117;
      border: 1px solid var(--grid-line);
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 0.75rem;
      font-family: monospace;
      min-width: 0;
    }

    .share-url-container input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .share-url-container button {
      flex-shrink: 0;
    }

    .grid-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .grid-wrapper {
      position: relative;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, var(--cell-size));
      grid-template-rows: repeat(12, var(--cell-size));
      background: #222;
      border: 2px solid var(--accent);
      border-radius: 4px;
      overflow: hidden;
    }

    .cell {
      width: var(--cell-size);
      height: var(--cell-size);
      background: #111;
      border: 1px solid var(--grid-line);
      transition: background-color 0.15s ease;
    }


    .axis-labels {
      position: absolute;
      font-size: 0.6rem;
      color: var(--text-muted);
      font-family: monospace;
    }

    .row-labels {
      left: -1.5rem;
      top: 0;
      display: flex;
      flex-direction: column;
    }

    .col-labels {
      top: -1.25rem;
      left: 0;
      display: flex;
    }

    .axis-label {
      width: var(--cell-size);
      height: var(--cell-size);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .row-labels .axis-label {
      width: 1.5rem;
    }

    .col-labels .axis-label {
      height: 1.25rem;
    }

    .editor-section {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .editor-title {
      font-size: 0.875rem;
      font-weight: 600;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    button:hover {
      background: var(--accent-hover);
    }

    button:active {
      transform: scale(0.98);
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--text-muted);
      color: var(--text-muted);
    }

    button.secondary:hover {
      border-color: var(--text);
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    button.success {
      background: var(--success);
    }

    button.success:hover {
      background: #5fe3b3;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .code-editor-wrapper {
      position: relative;
      width: 100%;
      height: 200px;
      background: #0d1117;
      border: 1px solid var(--grid-line);
      border-radius: 4px;
      overflow: hidden;
    }

    .code-editor-wrapper:focus-within {
      border-color: var(--accent);
    }

    .code-highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 0.75rem;
      margin: 0;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.875rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      pointer-events: none;
      color: #e6e6e6;
    }

    .code-editor {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      padding: 0.75rem;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.875rem;
      color: transparent;
      caret-color: white;
      resize: none;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .code-editor:focus {
      outline: none;
    }

    .code-editor::selection {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Syntax highlighting colors */
    .code-highlight .keyword {
      color: #ff79c6;
    }

    .code-highlight .function {
      color: #50fa7b;
    }

    .code-highlight .string {
      color: #f1fa8c;
    }

    .code-highlight .number {
      color: #bd93f9;
    }

    .code-highlight .comment {
      color: #6272a4;
      font-style: italic;
    }

    .code-highlight .operator {
      color: #ff79c6;
    }

    .code-highlight .plain {
      color: #e6e6e6;
    }

    .output {
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: #0d1117;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.75rem;
      max-height: 100px;
      overflow-y: auto;
      display: none;
    }

    .output.visible {
      display: block;
    }

    .output.error {
      color: #ff6b6b;
      border-left: 3px solid #ff6b6b;
    }

    .output.success {
      color: var(--success);
      border-left: 3px solid var(--success);
    }

    .help-section {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
    }

    .help-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .help-title::after {
      content: '\25BC';
      font-size: 0.6rem;
      transition: transform 0.2s;
    }

    .help-section.collapsed .help-title::after {
      transform: rotate(-90deg);
    }

    .help-content {
      display: block;
    }

    .help-section.collapsed .help-content {
      display: none;
    }

    .function-ref {
      margin-bottom: 1rem;
    }

    .function-ref h4 {
      font-size: 0.875rem;
      color: var(--accent);
      margin-bottom: 0.25rem;
      font-family: monospace;
    }

    .function-ref p {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    code {
      background: #0d1117;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.8rem;
    }

    .examples {
      display: grid;
      gap: 0.5rem;
    }

    .example-btn {
      background: rgba(233, 69, 96, 0.1);
      border: 1px solid var(--accent);
      color: var(--text);
      text-align: left;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }

    .example-btn:hover {
      background: rgba(233, 69, 96, 0.2);
    }

    .example-btn .example-name {
      font-weight: 600;
      display: block;
      margin-bottom: 0.125rem;
    }

    .example-btn .example-preview {
      font-family: monospace;
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    .color-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
      margin-top: 0.5rem;
    }

    .color-swatch {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 3px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.1s, border-color 0.1s;
    }

    .color-swatch:hover {
      transform: scale(1.15);
      border-color: white;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.75rem;
    }

    .speed-control input {
      flex: 1;
      max-width: 150px;
    }

    .coord-display {
      text-align: center;
      margin-top: 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      color: var(--text-muted);
      height: 1.25rem;
    }

    /* Tablet and up */
    @media (min-width: 600px) {
      :root {
        --grid-size: 420px;
      }

      body {
        padding: 2rem;
      }

      h1 {
        font-size: 2rem;
      }

      .subtitle {
        font-size: 1rem;
      }

      .code-editor-wrapper {
        height: 280px;
      }

      .code-editor,
      .code-highlight {
        font-size: 1rem;
      }

      .examples {
        grid-template-columns: repeat(2, 1fr);
      }

      .editor-area {
        max-width: 500px;
        margin: 0 auto;
      }
    }

    /* Desktop */
    @media (min-width: 900px) {
      :root {
        --grid-size: 480px;
      }

      .code-editor-wrapper {
        height: 320px;
      }

      .editor-area {
        max-width: 520px;
      }
    }

    /* Animation indicator */
    .running-indicator {
      display: none;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--success);
    }

    .running-indicator.visible {
      display: flex;
    }

    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--success);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Pixel Art Coordinate Challenge</h1>
      <p class="subtitle">The most voted for art wins a prize!</p>
      <button class="share-btn" id="shareBtn" onclick="shareCode()">Share</button>
      <div class="share-toast" id="shareToast">Link copied to clipboard!</div>
    </header>

    <div class="modal-overlay" id="shareModal" onclick="closeShareModal(event)">
      <div class="modal-content">
        <button class="modal-close" onclick="closeShareModal()">&times;</button>
        <h2>Share Your Creation</h2>
        <div class="qr-container">
          <img id="qrCode" src="" alt="QR Code">
        </div>
        <p class="modal-instruction">Scan the QR code or copy the link below:</p>
        <div class="share-url-container">
          <input type="text" id="shareUrl" readonly>
          <button onclick="copyShareUrl()">Copy</button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="grid-container">
        <div class="grid-wrapper">
          <div class="axis-labels row-labels" id="rowLabels"></div>
          <div class="axis-labels col-labels" id="colLabels"></div>
          <div class="grid" id="grid"></div>
        </div>
        <div class="coord-display" id="coordDisplay">Hover over a cell to see coordinates</div>
      </div>

      <div class="editor-area">
        <div class="editor-section">
          <div class="editor-header">
            <span class="editor-title">Your Code</span>
            <div class="running-indicator" id="runningIndicator">
              <div class="spinner"></div>
              <span>Running...</span>
            </div>
            <div class="btn-group">
              <button class="secondary" onclick="clearGrid()">Clear Grid</button>
              <button class="secondary" id="stopBtn" onclick="stopAnimation()" disabled>Stop</button>
              <button class="success" id="runBtn" onclick="runCode()">Run</button>
            </div>
          </div>
          <div class="code-editor-wrapper">
            <div class="code-highlight" id="codeHighlight"></div>
            <textarea class="code-editor" id="codeEditor" placeholder="// Try: fill(0, 0, 'red')
// Or click an example below!" spellcheck="false">// Draw an animated smiley face!

// Eyes
fill(3, 3, 'yellow'); await sleep(80);
fill(3, 8, 'yellow'); await sleep(80);
fill(4, 3, 'yellow'); await sleep(80);
fill(4, 8, 'yellow'); await sleep(80);

// Mouth
fill(7, 3, 'yellow'); await sleep(80);
fill(8, 4, 'yellow'); await sleep(80);
fill(8, 5, 'yellow'); await sleep(80);
fill(8, 6, 'yellow'); await sleep(80);
fill(8, 7, 'yellow'); await sleep(80);
fill(7, 8, 'yellow'); await sleep(80);

// Face outline
for (let col = 3; col <= 8; col++) {
  fill(1, col, 'orange'); await sleep(40);
}
for (let row = 2; row <= 9; row++) {
  fill(row, 9, 'orange'); await sleep(40);
}
for (let col = 8; col >= 3; col--) {
  fill(10, col, 'orange'); await sleep(40);
}
for (let row = 9; row >= 2; row--) {
  fill(row, 2, 'orange'); await sleep(40);
}</textarea>
          </div>
          <div class="output" id="output"></div>

          <div class="speed-control">
            <label for="speedSlider">Animation Speed:</label>
            <input type="range" id="speedSlider" min="10" max="500" value="100">
            <span id="speedValue">100ms</span>
          </div>
        </div>

        <div class="help-section" id="helpSection">
          <div class="help-title" onclick="toggleHelp()">Functions & Examples</div>
          <div class="help-content">
            <div class="function-ref">
              <h4>fill(row, col, color)</h4>
              <p>Colors a cell at the given row and column. Rows and columns start at 0.</p>
              <p>Example: <code>fill(0, 0, 'red')</code> colors the top-left cell red.</p>
            </div>

            <div class="function-ref">
              <h4>clear()</h4>
              <p>Clears all cells back to black. Useful for animations!</p>
            </div>

            <div class="function-ref">
              <h4>await sleep(ms)</h4>
              <p>Pauses execution for animations. Use with loops!</p>
              <p>Example: <code>await sleep(100)</code> waits 100 milliseconds.</p>
            </div>

            <div class="function-ref">
              <h4>Available Colors</h4>
              <div class="color-palette" id="colorPalette"></div>
            </div>

            <h4 style="margin: 1rem 0 0.5rem; font-size: 0.875rem;">Try These Examples:</h4>
            <div class="examples" id="examples"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // LZString compression for shorter URLs
    const LZString = (function () {
      const keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
      const baseReverseDic = {};

      function getBaseValue(alphabet, character) {
        if (!baseReverseDic[alphabet]) {
          baseReverseDic[alphabet] = {};
          for (let i = 0; i < alphabet.length; i++) {
            baseReverseDic[alphabet][alphabet.charAt(i)] = i;
          }
        }
        return baseReverseDic[alphabet][character];
      }

      function _compress(uncompressed, bitsPerChar, getCharFromInt) {
        if (uncompressed == null) return "";
        let i, value, context_dictionary = {}, context_dictionaryToCreate = {},
          context_c = "", context_wc = "", context_w = "", context_enlargeIn = 2,
          context_dictSize = 3, context_numBits = 2, context_data = [], context_data_val = 0,
          context_data_position = 0;

        for (let ii = 0; ii < uncompressed.length; ii++) {
          context_c = uncompressed.charAt(ii);
          if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
            context_dictionary[context_c] = context_dictSize++;
            context_dictionaryToCreate[context_c] = true;
          }
          context_wc = context_w + context_c;
          if (Object.prototype.hasOwnProperty.call(context_dictionary, context_wc)) {
            context_w = context_wc;
          } else {
            if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
              if (context_w.charCodeAt(0) < 256) {
                for (i = 0; i < context_numBits; i++) {
                  context_data_val = (context_data_val << 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else { context_data_position++; }
                }
                value = context_w.charCodeAt(0);
                for (i = 0; i < 8; i++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else { context_data_position++; }
                  value = value >> 1;
                }
              } else {
                value = 1;
                for (i = 0; i < context_numBits; i++) {
                  context_data_val = (context_data_val << 1) | value;
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else { context_data_position++; }
                  value = 0;
                }
                value = context_w.charCodeAt(0);
                for (i = 0; i < 16; i++) {
                  context_data_val = (context_data_val << 1) | (value & 1);
                  if (context_data_position == bitsPerChar - 1) {
                    context_data_position = 0;
                    context_data.push(getCharFromInt(context_data_val));
                    context_data_val = 0;
                  } else { context_data_position++; }
                  value = value >> 1;
                }
              }
              context_enlargeIn--;
              if (context_enlargeIn == 0) {
                context_enlargeIn = Math.pow(2, context_numBits);
                context_numBits++;
              }
              delete context_dictionaryToCreate[context_w];
            } else {
              value = context_dictionary[context_w];
              for (i = 0; i < context_numBits; i++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else { context_data_position++; }
                value = value >> 1;
              }
            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
              context_enlargeIn = Math.pow(2, context_numBits);
              context_numBits++;
            }
            context_dictionary[context_wc] = context_dictSize++;
            context_w = String(context_c);
          }
        }
        if (context_w !== "") {
          if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
            if (context_w.charCodeAt(0) < 256) {
              for (i = 0; i < context_numBits; i++) {
                context_data_val = (context_data_val << 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else { context_data_position++; }
              }
              value = context_w.charCodeAt(0);
              for (i = 0; i < 8; i++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else { context_data_position++; }
                value = value >> 1;
              }
            } else {
              value = 1;
              for (i = 0; i < context_numBits; i++) {
                context_data_val = (context_data_val << 1) | value;
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else { context_data_position++; }
                value = 0;
              }
              value = context_w.charCodeAt(0);
              for (i = 0; i < 16; i++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else { context_data_position++; }
                value = value >> 1;
              }
            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
              context_enlargeIn = Math.pow(2, context_numBits);
              context_numBits++;
            }
            delete context_dictionaryToCreate[context_w];
          } else {
            value = context_dictionary[context_w];
            for (i = 0; i < context_numBits; i++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else { context_data_position++; }
              value = value >> 1;
            }
          }
          context_enlargeIn--;
          if (context_enlargeIn == 0) {
            context_numBits++;
          }
        }
        value = 2;
        for (i = 0; i < context_numBits; i++) {
          context_data_val = (context_data_val << 1) | (value & 1);
          if (context_data_position == bitsPerChar - 1) {
            context_data_position = 0;
            context_data.push(getCharFromInt(context_data_val));
            context_data_val = 0;
          } else { context_data_position++; }
          value = value >> 1;
        }
        while (true) {
          context_data_val = (context_data_val << 1);
          if (context_data_position == bitsPerChar - 1) {
            context_data.push(getCharFromInt(context_data_val));
            break;
          } else context_data_position++;
        }
        return context_data.join('');
      }

      function _decompress(length, resetValue, getNextValue) {
        let dictionary = [], next, enlargeIn = 4, dictSize = 4, numBits = 3,
          entry = "", result = [], i, w, bits, resb, maxpower, power, c,
          data = { val: getNextValue(0), position: resetValue, index: 1 };

        for (i = 0; i < 3; i++) dictionary[i] = i;
        bits = 0; maxpower = Math.pow(2, 2); power = 1;
        while (power != maxpower) {
          resb = data.val & data.position;
          data.position >>= 1;
          if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
          bits |= (resb > 0 ? 1 : 0) * power;
          power <<= 1;
        }
        switch (next = bits) {
          case 0: bits = 0; maxpower = Math.pow(2, 8); power = 1;
            while (power != maxpower) {
              resb = data.val & data.position; data.position >>= 1;
              if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
              bits |= (resb > 0 ? 1 : 0) * power; power <<= 1;
            }
            c = String.fromCharCode(bits); break;
          case 1: bits = 0; maxpower = Math.pow(2, 16); power = 1;
            while (power != maxpower) {
              resb = data.val & data.position; data.position >>= 1;
              if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
              bits |= (resb > 0 ? 1 : 0) * power; power <<= 1;
            }
            c = String.fromCharCode(bits); break;
          case 2: return "";
        }
        dictionary[3] = c; w = c; result.push(c);
        while (true) {
          if (data.index > length) return "";
          bits = 0; maxpower = Math.pow(2, numBits); power = 1;
          while (power != maxpower) {
            resb = data.val & data.position; data.position >>= 1;
            if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
            bits |= (resb > 0 ? 1 : 0) * power; power <<= 1;
          }
          switch (c = bits) {
            case 0: bits = 0; maxpower = Math.pow(2, 8); power = 1;
              while (power != maxpower) {
                resb = data.val & data.position; data.position >>= 1;
                if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                bits |= (resb > 0 ? 1 : 0) * power; power <<= 1;
              }
              dictionary[dictSize++] = String.fromCharCode(bits); c = dictSize - 1; enlargeIn--; break;
            case 1: bits = 0; maxpower = Math.pow(2, 16); power = 1;
              while (power != maxpower) {
                resb = data.val & data.position; data.position >>= 1;
                if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
                bits |= (resb > 0 ? 1 : 0) * power; power <<= 1;
              }
              dictionary[dictSize++] = String.fromCharCode(bits); c = dictSize - 1; enlargeIn--; break;
            case 2: return result.join('');
          }
          if (enlargeIn == 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
          if (dictionary[c]) { entry = dictionary[c]; }
          else { if (c === dictSize) { entry = w + w.charAt(0); } else { return null; } }
          result.push(entry);
          dictionary[dictSize++] = w + entry.charAt(0);
          enlargeIn--;
          if (enlargeIn == 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
          w = entry;
        }
      }

      return {
        compressToEncodedURIComponent: function (input) {
          if (input == null) return "";
          return _compress(input, 6, function (a) { return keyStrUriSafe.charAt(a); });
        },
        decompressFromEncodedURIComponent: function (input) {
          if (input == null) return "";
          if (input == "") return null;
          input = input.replace(/ /g, "+");
          return _decompress(input.length, 32, function (index) { return getBaseValue(keyStrUriSafe, input.charAt(index)); });
        }
      };
    })();

    // Grid state
    const GRID_SIZE = 12;
    let cells = [];
    let isRunning = false;
    let shouldStop = false;

    // Available colors
    const colors = [
      'red', 'orange', 'yellow', 'lime', 'green', 'cyan',
      'blue', 'purple', 'magenta', 'pink', 'white', 'gray'
    ];

    // Example code snippets
    const examples = [
      {
        name: 'Checkerboard',
        code: `// Checkerboard pattern
for (let row = 0; row < 12; row++) {
  for (let col = 0; col < 12; col++) {
    if ((row + col) % 2 === 0) {
      fill(row, col, 'red');
    } else {
      fill(row, col, 'white');
    }
  }
}`
      },
      {
        name: 'Rainbow Rows',
        code: `// Rainbow rows with animation
const colors = ['red', 'orange', 'yellow', 'lime', 'cyan', 'blue'];
for (let row = 0; row < 12; row++) {
  for (let col = 0; col < 12; col++) {
    fill(row, col, colors[row % 6]);
    await sleep(20);
  }
}`
      },
      {
        name: 'Growing Square',
        code: `// Animated growing square
for (let size = 1; size <= 12; size++) {
  clear();
  for (let row = 0; row < size; row++) {
    for (let col = 0; col < size; col++) {
      fill(row, col, 'cyan');
    }
  }
  await sleep(150);
}`
      },
      {
        name: 'Diagonal Line',
        code: `// Draw a diagonal line
for (let i = 0; i < 12; i++) {
  fill(i, i, 'lime');
  await sleep(80);
}`
      },
      {
        name: 'Heart',
        code: `// Draw a heart
const heart = [
  [1,3], [1,4], [1,7], [1,8],
  [2,2], [2,5], [2,6], [2,9],
  [3,1], [3,10],
  [4,1], [4,10],
  [5,2], [5,9],
  [6,3], [6,8],
  [7,4], [7,7],
  [8,5], [8,6]
];
for (const [row, col] of heart) {
  fill(row, col, 'red');
}`
      },
      {
        name: 'Scrolling Hello',
        code: `// "HELLO" scrolls across the screen
const letters = {
  H: [[0,0],[1,0],[2,0],[3,0],[4,0],[2,1],[0,2],[1,2],[2,2],[3,2],[4,2]],
  E: [[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[2,1],[4,1],[0,2],[4,2]],
  L: [[0,0],[1,0],[2,0],[3,0],[4,0],[4,1],[4,2]],
  O: [[1,0],[2,0],[3,0],[0,1],[4,1],[1,2],[2,2],[3,2]]
};
const word = ['H','E','L','L','O'];
const spacing = 4;
const totalWidth = word.length * spacing + 12;

for (let offset = 0; offset < totalWidth; offset++) {
  clear();
  let x = 12 - offset;
  for (const char of word) {
    for (const [row, col] of letters[char]) {
      const drawCol = x + col;
      if (drawCol >= 0 && drawCol < 12) {
        fill(row + 4, drawCol, 'cyan');
      }
    }
    x += spacing;
  }
  await sleep(120);
}`
      }
    ];

    // Initialize the grid
    function initGrid() {
      const grid = document.getElementById('grid');
      const rowLabels = document.getElementById('rowLabels');
      const colLabels = document.getElementById('colLabels');

      // Create cells
      for (let row = 0; row < GRID_SIZE; row++) {
        for (let col = 0; col < GRID_SIZE; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = row;
          cell.dataset.col = col;
          cell.addEventListener('mouseenter', () => showCoords(row, col));
          cell.addEventListener('mouseleave', hideCoords);
          grid.appendChild(cell);
          cells.push(cell);
        }
      }

      // Create axis labels
      for (let i = 0; i < GRID_SIZE; i++) {
        const rowLabel = document.createElement('div');
        rowLabel.className = 'axis-label';
        rowLabel.textContent = i;
        rowLabels.appendChild(rowLabel);

        const colLabel = document.createElement('div');
        colLabel.className = 'axis-label';
        colLabel.textContent = i;
        colLabels.appendChild(colLabel);
      }
    }

    // Initialize color palette
    function initColorPalette() {
      const palette = document.getElementById('colorPalette');
      colors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.background = color;
        swatch.title = color;
        swatch.addEventListener('click', () => insertColor(color));
        palette.appendChild(swatch);
      });
    }

    // Initialize examples
    function initExamples() {
      const container = document.getElementById('examples');
      examples.forEach(example => {
        const btn = document.createElement('button');
        btn.className = 'example-btn';
        btn.innerHTML = `
          <span class="example-name">${example.name}</span>
          <span class="example-preview">${example.code.split('\n')[0]}</span>
        `;
        btn.addEventListener('click', () => loadExample(example.code));
        container.appendChild(btn);
      });
    }

    // Show coordinates on hover
    function showCoords(row, col) {
      document.getElementById('coordDisplay').textContent =
        `fill(${row}, ${col}, 'color')`;
    }

    function hideCoords() {
      document.getElementById('coordDisplay').textContent =
        'Hover over a cell to see coordinates';
    }

    // Insert color into editor
    function insertColor(color) {
      const editor = document.getElementById('codeEditor');
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      const text = editor.value;
      editor.value = text.substring(0, start) + `'${color}'` + text.substring(end);
      editor.focus();
      editor.selectionStart = editor.selectionEnd = start + color.length + 2;
    }

    // Load example code
    function loadExample(code) {
      document.getElementById('codeEditor').value = code;
      updateHighlight();
      clearGrid();
    }

    // Toggle help section
    function toggleHelp() {
      document.getElementById('helpSection').classList.toggle('collapsed');
    }

    // Speed slider
    document.getElementById('speedSlider').addEventListener('input', (e) => {
      document.getElementById('speedValue').textContent = e.target.value + 'ms';
    });

    // Grid functions available to user code
    function fill(row, col, color) {
      if (row < 0 || row >= GRID_SIZE || col < 0 || col >= GRID_SIZE) {
        throw new Error(`Invalid coordinates: (${row}, ${col}). Must be 0-11.`);
      }
      const index = row * GRID_SIZE + col;
      cells[index].style.backgroundColor = color;
    }

    function clearGrid() {
      cells.forEach(cell => {
        cell.style.backgroundColor = '#111';
      });
    }

    // Alias for user code
    function clear() {
      clearGrid();
    }

    function sleep(ms) {
      const speed = parseInt(document.getElementById('speedSlider').value);
      return new Promise((resolve, reject) => {
        if (shouldStop) {
          reject(new Error('Stopped'));
          return;
        }
        setTimeout(() => {
          if (shouldStop) {
            reject(new Error('Stopped'));
          } else {
            resolve();
          }
        }, ms || speed);
      });
    }

    // Stop animation
    function stopAnimation() {
      shouldStop = true;
    }

    // Run user code
    async function runCode() {
      if (isRunning) return;

      const code = document.getElementById('codeEditor').value;
      const output = document.getElementById('output');
      const runBtn = document.getElementById('runBtn');
      const stopBtn = document.getElementById('stopBtn');
      const indicator = document.getElementById('runningIndicator');

      isRunning = true;
      shouldStop = false;
      runBtn.disabled = true;
      stopBtn.disabled = false;
      indicator.classList.add('visible');
      output.className = 'output';
      output.textContent = '';

      try {
        // Wrap code in async function to support await
        const asyncCode = `(async () => { ${code} })()`;
        await eval(asyncCode);

        if (!shouldStop) {
          output.textContent = 'Code executed successfully!';
          output.className = 'output visible success';
        }
      } catch (error) {
        if (error.message !== 'Stopped') {
          output.textContent = `Error: ${error.message}`;
          output.className = 'output visible error';
        }
      } finally {
        isRunning = false;
        shouldStop = false;
        runBtn.disabled = false;
        stopBtn.disabled = true;
        indicator.classList.remove('visible');
      }
    }

    // Keyboard shortcut to run code
    document.getElementById('codeEditor').addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runCode();
      }
    });

    // Syntax highlighting
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function highlightCode(code) {
      if (!code) return '';

      // Split into tokens and highlight each
      const lines = code.split('\n');
      return lines.map(line => {
        // Check if line is a comment
        const commentMatch = line.match(/^(\s*)(\/\/.*)$/);
        if (commentMatch) {
          return escapeHtml(commentMatch[1]) + '<span class="comment">' + escapeHtml(commentMatch[2]) + '</span>';
        }

        // Process inline comments
        const inlineCommentIndex = line.indexOf('//');
        let mainPart = line;
        let commentPart = '';
        if (inlineCommentIndex !== -1) {
          mainPart = line.substring(0, inlineCommentIndex);
          commentPart = '<span class="comment">' + escapeHtml(line.substring(inlineCommentIndex)) + '</span>';
        }

        // Tokenize and highlight
        let result = mainPart
          // Strings first (to protect their contents)
          .replace(/('(?:[^'\\]|\\.)*')/g, '\x00STR\x00$1\x00/STR\x00')
          .replace(/("(?:[^"\\]|\\.)*")/g, '\x00STR\x00$1\x00/STR\x00');

        // Escape HTML in non-string parts
        const parts = result.split(/(\x00STR\x00.*?\x00\/STR\x00)/g);
        result = parts.map(part => {
          if (part.startsWith('\x00STR\x00')) {
            const str = part.slice(5, -6);
            return '<span class="string">' + escapeHtml(str) + '</span>';
          }
          // Escape and highlight non-string parts
          let escaped = escapeHtml(part);
          // Keywords
          escaped = escaped.replace(/\b(const|let|var|for|while|if|else|function|return|await|async|of|in)\b/g,
            '<span class="keyword">$1</span>');
          // Functions
          escaped = escaped.replace(/\b(fill|clear|sleep)\b(?=\s*\()/g,
            '<span class="function">$1</span>');
          // Numbers
          escaped = escaped.replace(/\b(\d+)\b/g, '<span class="number">$1</span>');
          return escaped;
        }).join('');

        return result + commentPart;
      }).join('\n');
    }

    function updateHighlight() {
      const editor = document.getElementById('codeEditor');
      const highlight = document.getElementById('codeHighlight');
      const code = editor.value;
      highlight.innerHTML = highlightCode(code) + '\n';
    }

    // Sync scroll position
    function syncScroll() {
      const editor = document.getElementById('codeEditor');
      const highlight = document.getElementById('codeHighlight');
      highlight.scrollTop = editor.scrollTop;
      highlight.scrollLeft = editor.scrollLeft;
    }

    document.getElementById('codeEditor').addEventListener('scroll', syncScroll);
    document.getElementById('codeEditor').addEventListener('input', updateHighlight);

    // Share functionality
    function encodeCode(code) {
      return LZString.compressToEncodedURIComponent(code);
    }

    function decodeCode(encoded) {
      try {
        return LZString.decompressFromEncodedURIComponent(encoded);
      } catch (e) {
        return null;
      }
    }

    function shareCode() {
      const code = document.getElementById('codeEditor').value;
      const encoded = encodeCode(code);
      const url = new URL(window.location.href);
      url.search = '';
      url.searchParams.set('code', encoded);
      const shareUrl = url.toString();

      // Generate QR code using API
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(shareUrl)}`;
      document.getElementById('qrCode').src = qrUrl;
      document.getElementById('shareUrl').value = shareUrl;

      // Show modal
      document.getElementById('shareModal').classList.add('visible');

      // Copy to clipboard
      navigator.clipboard.writeText(shareUrl).then(() => {
        const toast = document.getElementById('shareToast');
        toast.classList.add('visible');
        setTimeout(() => {
          toast.classList.remove('visible');
        }, 2500);
      }).catch(() => { });
    }

    function closeShareModal(event) {
      if (!event || event.target === event.currentTarget) {
        document.getElementById('shareModal').classList.remove('visible');
      }
    }

    function copyShareUrl() {
      const input = document.getElementById('shareUrl');
      input.select();
      navigator.clipboard.writeText(input.value).then(() => {
        const toast = document.getElementById('shareToast');
        toast.classList.add('visible');
        setTimeout(() => {
          toast.classList.remove('visible');
        }, 2500);
      });
    }

    function loadSharedCode() {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('code');
      if (encoded) {
        const code = decodeCode(encoded);
        if (code) {
          document.getElementById('codeEditor').value = code;
          updateHighlight();
        }
      }
    }

    // Initialize everything
    initGrid();
    initColorPalette();
    initExamples();
    loadSharedCode(); // Check for shared code in URL
    updateHighlight(); // Initial highlight
  </script>
</body>

</html>